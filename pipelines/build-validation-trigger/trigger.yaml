trigger: none
stages:
  - stage: Semgrep
    pool:
      vmImage: ubuntu-latest
    variables:
      - group: semgrep-ci
      - name: pullRequestId
        value: $[variables['system.pullRequest.pullRequestId']]
      - name: sourceBranch
        value: $[variables['system.pullRequest.sourceBranch']]
      - name: targetBranch
        value: $[variables['system.pullRequest.targetBranch']]
      - name: sourceCommitId
        value: $[variables['system.pullRequest.sourceCommitId']]
      - name: sourceRepositoryUri
        value: $[variables['system.pullRequest.sourceRepositoryUri']]
      - name: workingDirectory
        value: $(Build.SourcesDirectory)/scan-triggering/build-validation-trigger
    jobs:
      - job:
        displayName: Trigger Semgrep Scan
        steps:
          - task: UseNode@1
            inputs:
              version: "20.x"
            displayName: "Install Node.js"

          - script: |
              npm install
            displayName: "npm install"
            workingDirectory: $(workingDirectory)

          - script: |
              npm run build && npm start
            displayName: Invoke Semgrep Pipeline
            workingDirectory: $(workingDirectory)
            env:
              ORG_URL: $(orgUrl)
              PERSONAL_ACCESS_TOKEN: $(personalAccessToken)
              PROJECT_NAME: $(projectName)
              PIPELINE_ID: $(pipelineId)
              SOURCE_REPOSITORY_URI: $(sourceRepositoryUri)
              PULL_REQUEST_ID: $(pullRequestId)
              SOURCE_COMMIT_ID: $(sourceCommitId)
              SOURCE_BRANCH: $(sourceBranch)
              TARGET_BRANCH: $(targetBranch)
